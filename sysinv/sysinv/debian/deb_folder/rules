#!/usr/bin/make -f
#export DH_VERBOSE = 1

export DEB_HOST_ARCH ?= $(shell dpkg-architecture -qDEB_HOST_ARCH 2>/dev/null)

export PYBUILD_NAME=sysinv
export PBR_VERSION=1.0.0
DEBIAN_DIR := $(CURDIR)/debian/tmp
SYSINV_DIR := $(CURDIR)/sysinv

%:
	dh $@ --with python3 --buildsystem=pybuild

ifeq (,$(findstring nocheck, $(DEB_BUILD_OPTIONS)))
override_dh_auto_test:
	# FIXME: UTs run during packaging are currently broken
	PYTHONDIR=$(CURDIR) stestr run || true
endif

override_dh_install:
ifeq ($(DEB_HOST_ARCH),arm64)
	sed -i "s/ttyS0/ttyAMA0/" $(SYSINV_DIR)/db/sqlalchemy/models.py \
		$(SYSINV_DIR)/conductor/manager.py \
		$(SYSINV_DIR)/tests/db/utils.py \
		$(SYSINV_DIR)/tests/conductor/test_manager.py
endif
	python3 setup.py install -f --install-layout=deb \
		--root=$(CURDIR)/debian/tmp
	python3 setup.py bdist_wheel \
		--universal \
		-d $(CURDIR)/debian/sysinv-wheels/usr/share/python-wheel
	install -p -D -m 755 $(CURDIR)/etc/sysinv/motd-system $(CURDIR)/debian/tmp/etc/update-motd.d/10-system
	install -p -D -m 755 $(CURDIR)/etc/sysinv/sysinv_goenabled_check.sh $(CURDIR)/debian/tmp/etc/goenabled.d/sysinv_goenabled_check.sh
	install -p -D -m 700 $(CURDIR)/etc/sysinv/delete_load.sh $(CURDIR)/debian/tmp/etc/sysinv/upgrades/delete_load.sh
	install -p -D -m 644 debian/tmpfiles.conf $(CURDIR)/debian/tmp/usr/lib/tmpfiles.d/sysinv.conf
	install -p -D -m 700 $(CURDIR)/scripts/kube-cert-rotation.sh $(CURDIR)/debian/tmp/usr/bin/kube-cert-rotation.sh
	dh_install

override_dh_python3:
	dh_python3 --shebang=/usr/bin/python3

override_dh_installsystemd:
	dh_installsystemd --no-enable --name sysinv-api
	dh_installsystemd --no-enable --name sysinv-conductor

override_dh_fixperms:
	dh_fixperms -Xkube-cert-rotation.sh
